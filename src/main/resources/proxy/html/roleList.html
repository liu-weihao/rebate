<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge | chrome=1">
    <meta name="renderer" content="webkit">
    <title>角色列表</title>
    <link href="css/style.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="grid/css/GridManager.css">
</head>
<body>

<div class="place">
    <span>位置：</span>
    <ul class="placeul">
        <li><a href="#">首页</a></li>
        <li><a href="#">角色列表</a></li>
    </ul>
</div>

<div class="rightinfo">
    <table id="grid"></table>
</div>

<div class="tip">
    <div class="tiptop"><span>角色权限</span><a></a></div>
    <div class="tipinfo">
        <div class="formbody">
            <form id="menu">
                <input id="roleId" name="roleId" type="hidden" value=""/>
                <dl id="menus"></dl>
                <li><label>&nbsp;</label><input type="button" class="btn" value="确认保存" onclick="addRoleMenus()"/></li>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="grid/js/GridManager.js"></script>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $(".tiptop a").click(function(){
            $(".tip").fadeOut(200);
        });
        allMenus(); //初始化全部菜单
        $("#grid").grid({
            ajax_url: contextPath + '/web/role/list.web',
            columnData: [{
                key: 'roleName',
                width: '130px',
                text: '角色名称'
            }, {
                key: 'roleCode',
                width: '130px',
                text: '角色代码'
            }, {
                key: 'gmtCreate',
                text: '创建时间',
                align: 'center',
                template: function (createDate, rowObject) {
                    return new Date(createDate).format('YYYY-MM-DD HH:mm:ss');
                }
            }, {
                key: 'action',
                text: '操作',
                align: 'center',
                template: function (action, rowObject) {
                    return "<a style='color:#337ab7;' href=\"javascript:;\" onclick='show("+JSON.stringify(rowObject)+")'>角色授权</a>";
                }
            }]
        });
    });

    function show(role) {
        $("#roleId").val(role.id);
        $(":checkbox").attr("checked", false);
        menuList(); //初始化角色授权菜单
        $(".tip").fadeIn(200);
    }

    function allMenus() {
        $.ajax({
            url: contextPath + "/allMenus.web",
            type: "GET",
            success: function (result) {
                if (result.status == SUCCESS) {
                    var menuList = result.body;
                    console.log(menuList);
                    var leftmenu = $("#menus");
                    for (var i = 0; i < menuList.length; i++) {
                        var dd = $("<dd>");
                        dd.append("<div class='title'><span><input id='"+menuList[i].id+"' name='menuId' value='"+menuList[i].id+"' type='checkbox'/></span>"+menuList[i].menuName+"</div>");
                        var ul = $("<ul class='menuson'>");
                        var childList = menuList[i].childList;
                        for (var j = 0; j < childList.length; j++) {
                            ul.append("<li><cite></cite><input id='"+childList[j].id+"' name='menuId' value='"+childList[j].id+"' type='checkbox'/>"+childList[j].menuName+"<i></i></li>");
                        }
                        dd.append(ul);
                        leftmenu.append(dd);
                    }

                    //导航切换
                    $(".menuson li").click(function () {
                        $(".menuson li.active").removeClass("active");
                        $(this).addClass("active");
                    });
                    $('.title').click(function () {
                        var $ul = $(this).next('ul');
                        $('dd').find('ul').slideUp();
                        if ($ul.is(':visible')) {
                            $(this).next('ul').slideUp();
                        } else {
                            $(this).next('ul').slideDown();
                        }
                    });
                }
            }
        });
    }

    function menuList() {
        $.ajax({
            url: contextPath + "/menus.web",
            type: "GET",
            data: {"roleId": $("#roleId").val()},
            success: function (result) {
                if (result.status == SUCCESS) {
                    var menuList = result.body;
                    for (var i = 0; i < menuList.length; i++) {
                        $("#"+menuList[i].id).attr("checked", true);
                        var childList = menuList[i].childList;
                        for (var j = 0; j < childList.length; j++) {
                            $("#"+menuList[j].id).attr("checked", true);
                        }
                    }
                }
            }
        });
    }

    function addRoleMenus() {
        $.ajax({
            url: contextPath + "/addRoleMenus.web",
            type: "POST",
            data: $("#menu").serialize(),
            success: function (result) {
                if (result.status == SUCCESS) {
                    alert("授权成功");

                } else {
                    alert(result.message);
                }
            }
        });
    }
</script>
</body>
</html>